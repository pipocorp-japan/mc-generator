<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mobileconfig ジェネレーター</title>
    <style>
        :root {
            --bg-color: #f4f7f9;
            --sidebar-bg: #ffffff;
            --main-bg: #ffffff;
            --border-color: #e0e0e0;
            --primary-color: #007aff;
            --text-color: #333;
            --label-color: #555;
            --danger-color: #ff3b30;
            --card-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        #sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        #sidebar h2 {
            margin-top: 0;
            font-size: 1.2em;
            color: var(--primary-color);
        }
        #payload-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #payload-list li {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            border: 1px solid var(--border-color);
        }
        #payload-list li:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        #main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }
        #main-content h1 {
            margin-top: 0;
        }
        .payload-card {
            background-color: var(--main-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            position: relative;
        }
        .payload-card h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        .payload-card p.description {
            font-size: 0.9em;
            color: var(--label-color);
            margin-top: -10px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--label-color);
        }
        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="number"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-family: inherit;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-group input[type="file"] {
            width: 100%;
        }
        .form-group input[type="checkbox"] {
            margin-right: 10px;
        }
        .delete-payload {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            line-height: 30px;
            text-align: center;
        }
        #generate-btn-container {
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.9);
            border-top: 1px solid var(--border-color);
            position: sticky;
            bottom: 0;
            backdrop-filter: blur(5px);
        }
        #generate-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ffeeba;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <aside id="sidebar">
        <h2>コンポーネントを追加</h2>
        <ul id="payload-list"></ul>
    </aside>

    <main id="main-content">
        <h1>mobileconfig ジェネレーター</h1>
        <p>左のリストから追加したい機能を選んで、プロファイルを作成してください。</p>
        
        <div class="payload-card" id="general-settings">
            <h3>基本設定 (必須)</h3>
            <p class="description">プロファイル全体の名前や説明を決めます。</p>
            <div class="form-group">
                <label for="profile-name">プロファイル名</label>
                <input type="text" id="profile-name" placeholder="例: 便利な設定集" required>
            </div>
            <div class="form-group">
                <label for="profile-id">プロファイルID</label>
                <input type="text" id="profile-id" placeholder="例: com.example.myprofile" required>
            </div>
            <div class="form-group">
                <label for="profile-desc">プロファイルの説明</label>
                <input type="text" id="profile-desc" placeholder="Wi-FiやWebクリップの設定です">
            </div>
        </div>

        <div id="payload-container"></div>
        
        <div id="generate-btn-container">
            <button id="generate-btn">完成 & ダウンロード</button>
        </div>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const payloadList = document.getElementById('payload-list');
        const payloadContainer = document.getElementById('payload-container');
        const generateBtn = document.getElementById('generate-btn');

        const generateUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16).toUpperCase();
        });

        // --- ペイロード定義 (mcfutures.json の内容をここに統合) ---
        const PAYLOAD_DEFINITIONS = {
          "com.apple.webClip.managed": {
            "name": "Webクリップ",
            "description": "Webサイトへのショートカットをホーム画面に作成します。",
            "fields": [
              { "key": "Label", "label": "アイコンのラベル", "type": "text", "placeholder": "例: ChatGPT", "required": true },
              { "key": "URL", "label": "WebサイトのURL", "type": "url", "placeholder": "https://chat.openai.com/", "required": true },
              { "key": "IsRemovable", "label": "ユーザーによる削除を許可", "type": "checkbox", "checked": true },
              { "key": "FullScreen", "label": "フルスクリーンで開く", "type": "checkbox" },
              { "key": "Icon", "label": "アイコン画像 (PNG)", "type": "file", "isBase64": true },
              { "key": "TargetApplicationBundleIdentifier", "label": "開くブラウザを指定 (上級者向け)", "type": "text", "placeholder": "例: com.google.chrome.ios" }
            ]
          },
          "com.apple.font": {
            "name": "フォント",
            "description": "カスタムフォント（.ttf または .otf）をiPad/iPhoneにインストールします。",
            "fields": [
              { "key": "Name", "label": "フォント名 (システムでの表示名)", "type": "text", "placeholder": "例: My Cool Font", "required": true },
              { "key": "Font", "label": "フォントファイル (.ttf, .otf)", "type": "file", "isBase64": true, "required": true }
            ]
          },
          "com.apple.wifi.managed": {
            "name": "Wi-Fi設定",
            "description": "Wi-Fiの接続情報を自動で設定します。パスワード入力の手間が省けます。",
            "fields": [
              { "key": "PayloadDisplayName", "label": "設定名", "type": "text", "placeholder": "例: 自宅のWi-Fi", "required": true },
              { "key": "SSID_STR", "label": "Wi-Fi名 (SSID)", "type": "text", "placeholder": "例: MyHome-WiFi", "required": true },
              { "key": "HIDDEN_NETWORK", "label": "ステルスネットワーク", "type": "checkbox" },
              { "key": "AutoJoin", "label": "自動接続する", "type": "checkbox", "checked": true },
              { "key": "EncryptionType", "label": "暗号化の種類", "type": "select", "options": ["WPA3", "WPA2", "WPA", "WEP", "Any", "None"], "required": true },
              { "key": "Password", "label": "パスワード", "type": "text", "placeholder": "パスワードを入力" }
            ]
          },
          "com.apple.wallpaper": {
            "name": "壁紙",
            "description": "ホーム画面やロック画面の壁紙を設定します。画像ファイルが必要です。",
            "fields": [
                { "key": "Image", "label": "壁紙画像 (JPG, PNG)", "type": "file", "isBase64": true, "required": true },
                { "key": "Where", "label": "設定する場所", "type": "select", "options": ["Both", "Home Screen", "Lock Screen"] }
            ]
          },
          "com.apple.homescreenlayout": {
              "name": "ホーム画面レイアウト",
              "description": "ホーム画面のアイコン配置を定義します。Dockと各ページのアプリをjson形式で指定する上級者向け機能です。",
              "fields": [
                  { "key": "Dock", "label": "Dockに配置するアプリのID (JSON配列)", "type": "textarea", "placeholder": "例: [\"com.apple.safari\", \"com.apple.mobilenotes\"]" },
                  { "key": "Pages", "label": "各ページに配置するアプリのID (JSON配列の配列)", "type": "textarea", "placeholder": "例: [[\"com.apple.calculator\"], [\"com.apple.mobilecal\"]]" }
              ]
          },
          "com.apple.subscribedcalendar.account": {
            "name": "カレンダーの照会",
            "description": "インターネットで公開されているカレンダーを登録します。",
            "fields": [
              { "key": "SubCalAccountDescription", "label": "カレンダーの説明", "type": "text", "placeholder": "例: 日本の祝日", "required": true },
              { "key": "SubCalAccountHostName", "label": "カレンダーのURL (.ics)", "type": "url", "placeholder": "https://example.com/calendar.ics", "required": true },
              { "key": "SubCalAccountUseSSL", "label": "SSLを使用する", "type": "checkbox", "checked": true }
            ]
          },
          "com.apple.mail.managed": {
              "name": "メールアカウント",
              "description": "メールアカウント（IMAP/POP）を自動で設定します。",
              "fields": [
                  { "key": "EmailAccountDescription", "label": "アカウントの説明", "type": "text", "placeholder": "例: Gmail", "required": true },
                  { "key": "EmailAddress", "label": "メールアドレス", "type": "text", "placeholder": "user@example.com", "required": true },
                  { "key": "IncomingMailServerHostName", "label": "受信サーバ (IMAP/POP)", "type": "text", "placeholder": "imap.gmail.com" },
                  { "key": "OutgoingMailServerHostName", "label": "送信サーバ (SMTP)", "type": "text", "placeholder": "smtp.gmail.com" }
              ]
          },
          "com.apple.mobiledevice.passwordpolicy": {
            "name": "パスコードのルール",
            "warning": "注意: 既にMDM等でポリシーが設定されている場合、競合する可能性があります。",
            "description": "パスコードの長さや、ロックするまでの時間などのルールを決めます。",
            "fields": [
              { "key": "allowSimple", "label": "単純なパスコードを許可 (1111など)", "type": "checkbox", "checked": true },
              { "key": "minLength", "label": "最小文字数", "type": "number", "placeholder": "例: 4" },
              { "key": "maxFailedAttempts", "label": "失敗回数の上限", "type": "number", "placeholder": "例: 10" },
              { "key": "maxGracePeriod", "label": "画面ロック後にパスコードを要求するまでの時間 (秒)", "type": "number", "placeholder": "例: 60" }
            ]
          },
          "com.apple.applicationaccess": {
            "name": "機能制限 (上級者向け)",
            "warning": "注意: MDMなどで既に制限がかかっている場合、この設定は効果がないか、競合する可能性があります。",
            "description": "Appのインストールやカメラの使用などを制限/許可します。",
            "fields": [
              { "key": "allowAppInstallation", "label": "Appのインストールを許可", "type": "checkbox" },
              { "key": "allowAppRemoval", "label": "Appの削除を許可", "type": "checkbox" },
              { "key": "allowCamera", "label": "カメラの使用を許可", "type": "checkbox", "checked": true },
              { "key": "allowScreenShot", "label": "スクリーンショットを許可", "type": "checkbox", "checked": true },
              { "key": "allowSafari", "label": "Safariの使用を許可", "type": "checkbox", "checked": true }
            ]
          }
        };

        // サイドバーにリストを生成
        for (const type in PAYLOAD_DEFINITIONS) {
            const li = document.createElement('li');
            li.textContent = PAYLOAD_DEFINITIONS[type].name;
            li.dataset.payloadType = type;
            payloadList.appendChild(li);
        }

        // サイドバーの項目クリックイベント
        payloadList.addEventListener('click', (e) => {
            if (e.target.tagName === 'LI') {
                const payloadType = e.target.dataset.payloadType;
                addPayloadCard(payloadType);
            }
        });

        // ペイロードカードをDOMに追加する関数
        function addPayloadCard(payloadType) {
            const definition = PAYLOAD_DEFINITIONS[payloadType];
            if (!definition) return;

            const card = document.createElement('div');
            card.className = 'payload-card';
            card.dataset.payloadType = payloadType;

            let html = `
                <button class="delete-payload" title="この項目を削除">×</button>
                <h3>${definition.name}</h3>
                <p class="description">${definition.description}</p>
            `;

            if (definition.warning) {
                html += `<div class="warning">${definition.warning}</div>`;
            }

            definition.fields.forEach((field) => {
                const inputId = `${payloadType}-${field.key}-${Date.now()}`;
                html += '<div class="form-group">';
                
                if (field.type === 'checkbox') {
                    html += `
                        <label>
                            <input type="checkbox" data-key="${field.key}" ${field.checked ? 'checked' : ''}>
                            ${field.label}
                        </label>
                    `;
                } else {
                    html += `<label for="${inputId}">${field.label}</label>`;
                    if (field.type === 'select') {
                        html += `<select id="${inputId}" data-key="${field.key}" ${field.required ? 'required' : ''}>`;
                        field.options.forEach(opt => {
                            html += `<option value="${opt}">${opt}</option>`;
                        });
                        html += `</select>`;
                    } else if (field.type === 'file') {
                         html += `<input type="${field.type}" id="${inputId}" data-key="${field.key}" data-is-base64="${field.isBase64 || false}" ${field.required ? 'required' : ''}>`;
                    } else if (field.type === 'textarea') {
                         html += `<textarea id="${inputId}" data-key="${field.key}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}></textarea>`;
                    } else {
                        html += `<input type="${field.type || 'text'}" id="${inputId}" data-key="${field.key}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}>`;
                    }
                }
                html += '</div>';
            });

            card.innerHTML = html;
            payloadContainer.appendChild(card);
        }

        // 削除ボタンのイベント
        payloadContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-payload')) {
                e.target.closest('.payload-card').remove();
            }
        });

        // 生成ボタンのイベント
        generateBtn.addEventListener('click', async () => {
            const profileName = document.getElementById('profile-name').value;
            const profileId = document.getElementById('profile-id').value;
            const profileDesc = document.getElementById('profile-desc').value;

            if (!profileName || !profileId) {
                alert('基本設定の「プロファイル名」と「プロファイルID」は必須です。');
                return;
            }

            const mobileConfig = {
                PayloadDisplayName: profileName,
                PayloadIdentifier: profileId,
                PayloadDescription: profileDesc || '',
                PayloadUUID: generateUUID(),
                PayloadType: 'Configuration',
                PayloadVersion: 1,
                PayloadContent: []
            };

            const payloadCards = payloadContainer.querySelectorAll('.payload-card');
            const fileReadPromises = [];

            payloadCards.forEach(card => {
                const payloadType = card.dataset.payloadType;
                const definition = PAYLOAD_DEFINITIONS[payloadType];
                if (!definition) return;

                const payload = {
                    PayloadType: payloadType,
                    PayloadUUID: generateUUID(),
                    PayloadIdentifier: `${profileId}.${payloadType}.${generateUUID()}`,
                    PayloadVersion: 1,
                };
                
                const displayNameInput = card.querySelector('[data-key="PayloadDisplayName"]');
                if (displayNameInput) {
                    payload.PayloadDisplayName = displayNameInput.value;
                }

                card.querySelectorAll('[data-key]').forEach(input => {
                    const key = input.dataset.key;
                    if (key === 'PayloadDisplayName') return;

                    if (input.type === 'checkbox') {
                        payload[key] = input.checked;
                    } else if (input.type === 'file') {
                        if (input.files && input.files[0]) {
                            const file = input.files[0];
                            const promise = new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    const base64String = e.target.result.split(',')[1];
                                    payload[key] = { __is_data: true, value: base64String };
                                    resolve();
                                };
                                reader.onerror = reject;
                                reader.readAsDataURL(file);
                            });
                            fileReadPromises.push(promise);
                        }
                    } else { 
                        if (input.value) {
                           if ((key === 'Dock' || key === 'Pages') && payloadType === 'com.apple.homescreenlayout') {
                               try {
                                   payload[key] = JSON.parse(input.value);
                               } catch(e) {
                                   console.warn(`'${key}' のJSONパースに失敗しました。文字列として扱います。:`, input.value);
                                   payload[key] = input.value;
                               }
                           } else {
                               payload[key] = (input.type === 'number') ? Number(input.value) : input.value;
                           }
                        }
                    }
                });
                mobileConfig.PayloadContent.push(payload);
            });

            await Promise.all(fileReadPromises);

            const plist = generatePlist(mobileConfig);
            downloadFile(plist, `${profileName.replace(/\s/g, '_') || 'generated'}.mobileconfig`, 'application/x-apple-aspen-config');
        });

        function generatePlist(obj) {
            let plist = `<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n<plist version="1.0">\n`;
            plist += jsToPlist(obj, 0);
            plist += '</plist>';
            return plist;
        }

        function jsToPlist(obj, indentLevel = 0) {
            let xml = '';
            const indent = '\t'.repeat(indentLevel);

            if (obj === null || obj === undefined) {
                return '';
            } else if (typeof obj === 'boolean') {
                return `${indent}<${obj}/>\n`;
            } else if (typeof obj === 'string') {
                return `${indent}<string>${escapeXml(obj)}</string>\n`;
            } else if (typeof obj === 'number') {
                return `${indent}<integer>${obj}</integer>\n`;
            } else if (obj.__is_data) {
                return `${indent}<data>${obj.value}</data>\n`;
            } else if (Array.isArray(obj)) {
                xml += `${indent}<array>\n`;
                obj.forEach(item => {
                    xml += jsToPlist(item, indentLevel + 1);
                });
                xml += `${indent}</array>\n`;
            } else if (typeof obj === 'object') {
                xml += `${indent}<dict>\n`;
                for (const key in obj) {
                    if (Object.prototype.hasOwnProperty.call(obj, key)) {
                        xml += `${indent}\t<key>${escapeXml(key)}</key>\n`;
                        xml += jsToPlist(obj[key], indentLevel + 1);
                    }
                }
                xml += `${indent}</dict>\n`;
            }
            return xml;
        }

        function escapeXml(str) {
            return String(str).replace(/[<>&'"]/g, c => {
                switch (c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case '\'': return '&apos;';
                    case '"': return '&quot;';
                }
            });
        }
        
        function downloadFile(content, fileName, contentType) {
            const a = document.createElement("a");
            const file = new Blob([content], {type: contentType});
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }
    });
    </script>
</body>
</html>