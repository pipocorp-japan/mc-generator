<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高度な mobileconfig ジェネレーター</title>
    <style>
        /* CSSスタイルは変更がないため、内容は省略します */
        :root { --bg-color: #f4f7f9; --sidebar-bg: #ffffff; --main-bg: #ffffff; --border-color: #e0e0e0; --primary-color: #007aff; --text-color: #333; --label-color: #555; --danger-color: #ff3b30; --card-shadow: 0 4px 8px rgba(0,0,0,0.05); } body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; } #sidebar { width: 280px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); padding: 20px; overflow-y: auto; flex-shrink: 0; } #sidebar h2 { margin-top: 0; font-size: 1.2em; color: var(--primary-color); } #payload-list { list-style: none; padding: 0; margin: 0; } #payload-list li { padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, color 0.2s; border: 1px solid var(--border-color); } #payload-list li:hover { background-color: var(--primary-color); color: white; border-color: var(--primary-color); } #main-content { flex-grow: 1; padding: 30px; overflow-y: auto; } #main-content h1 { margin-top: 0; } .payload-card { background-color: var(--main-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: var(--card-shadow); position: relative; } .payload-card h3 { margin-top: 0; color: var(--primary-color); } .payload-card p.description { font-size: 0.9em; color: var(--label-color); margin-top: -10px; margin-bottom: 20px; } .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--label-color); } .form-group input[type="text"], .form-group input[type="url"], .form-group input[type="number"], .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-family: inherit; } .form-group textarea { min-height: 100px; resize: vertical; } .form-group input[type="file"] { width: 100%; } .form-group input[type="checkbox"] { margin-right: 10px; } .delete-payload { position: absolute; top: 15px; right: 15px; background-color: var(--danger-color); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-weight: bold; cursor: pointer; font-size: 16px; line-height: 30px; text-align: center; } #generate-btn-container { padding: 20px 30px; background: rgba(255, 255, 255, 0.9); border-top: 1px solid var(--border-color); position: sticky; bottom: 0; backdrop-filter: blur(5px); } #generate-btn { background-color: var(--primary-color); color: white; padding: 15px 30px; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; width: 100%; } .warning { background-color: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba; margin-bottom: 20px; }
    </style>
</head>
<body>
    <aside id="sidebar">
        <h2>コンポーネントを追加</h2>
        <ul id="payload-list"></ul>
    </aside>

    <main id="main-content">
        <h1>高度な mobileconfig ジェネレーター</h1>
        <p>左のリストから追加したい機能を選んで、プロファイルを作成してください。</p>
        <div class="payload-card" id="general-settings">
            <h3>基本設定 (必須)</h3>
            <p class="description">プロファイル全体の名前や説明を決めます。</p>
            <div class="form-group">
                <label for="profile-name">プロファイル名</label>
                <input type="text" id="profile-name" placeholder="例: 高度な設定プロファイル" required>
            </div>
            <div class="form-group">
                <label for="profile-id">プロファイルID</label>
                <input type="text" id="profile-id" placeholder="例: com.example.advancedprofile" required>
            </div>
        </div>
        <div id="payload-container"></div>
        <div id="generate-btn-container">
            <button id="generate-btn">完成 & ダウンロード</button>
        </div>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const payloadList = document.getElementById('payload-list');
        const payloadContainer = document.getElementById('payload-container');
        const generateBtn = document.getElementById('generate-btn');

        let PAYLOAD_DEFINITIONS = {};

        // --- ここが重要な変更点です ---
        // 外部のJSONファイルを読み込んでジェネレーターを初期化します
        async function initializeGenerator() {
            try {
                // 'mcdb.json' を読み込みます
                const response = await fetch('mcdb.json');
                if (!response.ok) {
                    throw new Error('mcdb.jsonの読み込みに失敗しました。ファイルが存在するか確認してください。');
                }
                PAYLOAD_DEFINITIONS = await response.json();
                
                // JSONからサイドバーのリストを生成します
                for (const type in PAYLOAD_DEFINITIONS) {
                    const li = document.createElement('li');
                    li.textContent = PAYLOAD_DEFINITIONS[type].name;
                    li.dataset.payloadType = type;
                    payloadList.appendChild(li);
                }
            } catch (error) {
                console.error(error);
                alert(error.message);
            }
        }

        // --- これより下のJavaScriptは、前回の完成版と同じです ---
        const generateUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16).toUpperCase(); });

        initializeGenerator();

        payloadList.addEventListener('click', (e) => { if (e.target.tagName === 'LI') addPayloadCard(e.target.dataset.payloadType); });

        function addPayloadCard(payloadType) {
            const definition = PAYLOAD_DEFINITIONS[payloadType];
            if (!definition) return;
            const card = document.createElement('div');
            card.className = 'payload-card';
            card.dataset.payloadType = payloadType;
            let html = `<button class="delete-payload" title="この項目を削除">×</button><h3>${definition.name}</h3><p class="description">${definition.description}</p>`;
            if (definition.warning) html += `<div class="warning">${definition.warning}</div>`;
            definition.fields.forEach((field) => {
                const inputId = `${payloadType}-${field.key}-${Date.now()}`;
                html += '<div class="form-group">';
                if (field.type === 'checkbox') {
                    html += `<label><input type="checkbox" data-key="${field.key}" ${field.checked ? 'checked' : ''}> ${field.label}</label>`;
                } else {
                    html += `<label for="${inputId}">${field.label}</label>`;
                    if (field.type === 'select') {
                        html += `<select id="${inputId}" data-key="${field.key}" ${field.required ? 'required' : ''}>`;
                        field.options.forEach(opt => { html += `<option value="${opt}">${opt}</option>`; });
                        html += `</select>`;
                    } else if (field.type === 'file') {
                        html += `<input type="${field.type}" id="${inputId}" data-key="${field.key}" data-is-base64="${field.isBase64 || false}" ${field.required ? 'required' : ''}>`;
                    } else if (field.type === 'textarea') {
                        html += `<textarea id="${inputId}" data-key="${field.key}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}></textarea>`;
                    } else {
                        html += `<input type="${field.type || 'text'}" id="${inputId}" data-key="${field.key}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}>`;
                    }
                }
                html += '</div>';
            });
            card.innerHTML = html;
            payloadContainer.appendChild(card);
        }
        payloadContainer.addEventListener('click', (e) => { if (e.target.classList.contains('delete-payload')) e.target.closest('.payload-card').remove(); });
        generateBtn.addEventListener('click', async () => {
            const profileName = document.getElementById('profile-name').value;
            if (!profileName || !document.getElementById('profile-id').value) { alert('基本設定の「プロファイル名」と「プロファイルID」は必須です。'); return; }
            const mobileConfig = { PayloadDisplayName: profileName, PayloadIdentifier: document.getElementById('profile-id').value, PayloadUUID: generateUUID(), PayloadType: 'Configuration', PayloadVersion: 1, PayloadContent: [] };
            const fileReadPromises = [];
            payloadContainer.querySelectorAll('.payload-card').forEach(card => {
                const payloadType = card.dataset.payloadType;
                const payload = { PayloadType: payloadType, PayloadUUID: generateUUID(), PayloadIdentifier: `${mobileConfig.PayloadIdentifier}.${payloadType}.${generateUUID()}`, PayloadVersion: 1 };
                card.querySelectorAll('[data-key]').forEach(input => {
                    const key = input.dataset.key;
                    if (input.type === 'checkbox') { payload[key] = input.checked; }
                    else if (input.type === 'file') {
                        if (input.files && input.files[0]) fileReadPromises.push(new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => { payload[key] = { __is_data: true, value: e.target.result.split(',')[1] }; resolve(); }; reader.onerror = reject; reader.readAsDataURL(input.files[0]); }));
                    } else if (input.value) {
                        try { payload[key] = (key === 'Dock' || key === 'Pages') ? JSON.parse(input.value) : ((input.type === 'number') ? Number(input.value) : input.value); } catch(e) { console.warn("JSON parse failed"); payload[key] = input.value; }
                    }
                });
                mobileConfig.PayloadContent.push(payload);
            });
            await Promise.all(fileReadPromises);
            downloadFile(generatePlist(mobileConfig), `${profileName.replace(/\s/g, '_') || 'generated'}.mobileconfig`, 'application/x-apple-aspen-config');
        });
        function generatePlist(obj) { let plist = `<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n<plist version="1.0">\n`; plist += jsToPlist(obj, 0); plist += '</plist>'; return plist; }
        function jsToPlist(obj, indentLevel = 0) { let xml = ''; const indent = '\t'.repeat(indentLevel); if (obj === null || obj === undefined) return ''; if (typeof obj === 'boolean') return `${indent}<${obj}/>\n`; if (typeof obj === 'string') return `${indent}<string>${escapeXml(obj)}</string>\n`; if (typeof obj === 'number') return `${indent}<integer>${obj}</integer>\n`; if (obj.__is_data) return `${indent}<data>${obj.value}</data>\n`; if (Array.isArray(obj)) { xml += `${indent}<array>\n`; obj.forEach(item => { xml += jsToPlist(item, indentLevel + 1); }); xml += `${indent}</array>\n`; } else if (typeof obj === 'object') { xml += `${indent}<dict>\n`; for (const key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { xml += `${indent}\t<key>${escapeXml(key)}</key>\n`; xml += jsToPlist(obj[key], indentLevel + 1); } } xml += `${indent}</dict>\n`; } return xml; }
        function escapeXml(str) { return String(str).replace(/[<>&'"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','\'':'&apos;','"':'&quot;'})[c]); }
        function downloadFile(content, fileName, contentType) { const a = document.createElement("a"); const file = new Blob([content], {type: contentType}); a.href = URL.createObjectURL(file); a.download = fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href); }
    });
    </script>
</body>
</html>